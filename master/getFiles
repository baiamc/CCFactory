-- Handles getFiles events.  This is called when a new computer connects to the network.
-- Gets all the files that belong to that computer type and sends it to that computer

-- Assumes:
--  es is EventSystem API
--  modem is modem pheripheral

os.loadAPI("apis/const")

function getFiles(event, side, recvChannel, replyChannel, text)
	local idx
	if recvChannel ~= 1 then
		return nil
	end

	local message = textutils.unserialize(text)
	if message.type ~= "getFiles" then
		return nil
	end

	-- Send all computer specific files
	fileList = fs.list(message.computerType)
	if #fileList == 0 then
		print("ERROR!  Unknown computer type: "..message.computerType)
		return nil
	end

	local handle, response
	response = {
		type = "getFilesResponse"
	}
	for _, file in pairs(fileList) do
		handle = fs.open(fs.combine(message.computerType,file), "r")
		response[file] = handle.readAll()
	end

	-- Send APIs
	fileList = fs.list("apis")
	if #fileList > 0 then
		for _, file in pairs(fileList) do
			handle = fs.open(fs.combine("apis",file), "r")
			response["apis/"..file] = handle.readAll()
		end
	end
	modem.open(replyChannel)
	modem.transmit(replyChannel, const.channel.admin, textutils.serialize(response))
	modem.close(replyChannel)
end

es.addHandler("modem_message", getFiles)