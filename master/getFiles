-- Handles getFiles events.  This is called when a new computer connects to the network.

-- Assumes:
--  es is EventSystem API
--  modem is modem pheripheral

function getFiles(event, side, recvChannel, replyChannel, text)
	print("got message")
	if recvChannel ~= 1 then
		print("wrong channel ",recvChannel)
		return nil
	end

	print("message text: ", text)

	local message = textutils.unserialize(text)
	if message.type ~= "getFiles" then
		print("Wrong type: ",message.type)
		return nil
	end

	fileList = fs.list(message.computerType)
	if #fileList == 0 then
		print("ERROR!  Unknown computer type: "..message.computerType)
		return nil
	end

	local handle, response
	response = {
		type = "getFilesResponse"
	}
	for _, file in pairs(fileList) do
		handle = fs.open(fs.combine(message.computerType,file), "r")
		response[file] = handle.readAll()
		print("File contents:")
		print(response[file])
	end
	modem.open(replyChannel)
	modem.transmit(replyChannel, 1, textutils.serialize(response))
	modem.close(replyChannel)
end

es.addHandler("modem_message", getFiles)