-- Functionality common to all slave computers
if not const then os.loadAPI("apis/const") end
if not utils then os.loadAPI("apis/utils") end
if not es then os.loadAPI("apis/es") end

local function watchForReload(event, side, recvChannel, replyChannel, text)
	if recvChannel ~= const.channel.admin then 
		return nil 
	end

	if not text or #text == 0 then
		print("ERROR! No message text supplied.")
		return nil
	end
	local message = textutils.unserialize(text)

	if message.type ~= "reload" then 
		return nil
	end

	es.exit()

end

-- Makes the modem and params varriables available
function init()
	local sides, side, ptype
	-- Find peripherals
	sides = { "top", "bottom", "left", "right", "back" }
	for _, side in pairs(sides) do
		ptype = peripheral.getType(side)
		if ptype == "modem" then
			modem = peripheral.wrap(side)
		end
		if ptype == "interactiveSorter" then
			sorter = peripheral.wrap(side)
		end
		if modem == nil then
			error("Could not find modem!")
		end
	end

	-- Get params
	handle = fs.open(".params", "r")
	if handle then
		data = handle.readAll()
		if data ~= nil then
			params = textutils.unserialize(data)
		end
		handle.close()
	end

	-- Listen for code updates
	utils.modemHander(const.channel.admin, os.getComputerLabel(), function (message)
		local filename, text, handle
		if not message.code then return nil end
		for filename, text in pairs(code) do
			handle = fs.open(filename, "w")
			handle.write(text)
			handle.close()
		end
		es.exit()
	end)

	return modem, params
end
